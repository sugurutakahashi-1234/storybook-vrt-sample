# ==============================================
# Git Hooks 設定（Lefthook）
# ==============================================
# pre-commit: ステージされたファイルのみ対象（高速）
# pre-push:   プロジェクト全体を対象（プッシュ前の最終チェック）
#
# ==============================================

# コミット時: ステージされたファイルに対して実行
# 手動実行: bunx lefthook run pre-commit --force
pre-commit:
  parallel: true
  jobs:
    # Biome によるリント + フォーマット自動修正（修正後に再ステージ）
    - name: lint-fix
      run: bunx biome check --write {staged_files}
      glob: "**/*.{js,jsx,ts,tsx,json,jsonc,css}"
      exclude: "**/next-env.d.ts"
      stage_fixed: true
    # コンフリクトマーカー（<<<<<<< 等）の残存チェック
    - name: conflict-markers
      run: grep -rn '<<<<<<< \|======= \|>>>>>>> ' {staged_files} && echo "コンフリクトマーカーが残っています" && exit 1 || exit 0
      glob:
        - "**/*.{js,jsx,ts,tsx,json,jsonc,css,md,yml,yaml}"
    # .env ファイルの誤コミット防止
    - name: no-secrets
      run: git diff --cached --name-only | grep -E '\.env($|\.)' && echo ".env ファイルはコミットできません" && exit 1 || exit 0

# プッシュ時: プロジェクト全体に対して実行
# 手動実行: bunx lefthook run pre-push --force
pre-push:
  parallel: true
  jobs:
    # Biome によるリント + フォーマットチェック（修正なし、CI と同等）
    - name: lint-check
      run: bun run lint
    # TypeScript 型チェック（tsc --noEmit）
    - name: typecheck
      run: bun run typecheck
    # Next.js ビルド
    - name: build
      run: bun run build
    # bun バージョン整合性チェック（packageManager vs インストール済みバージョン）
    - name: bun-version-check
      run: bun run scripts/check-bun-version.ts
    # 依存パッケージバージョン整合性チェック（モノレポ内で同一パッケージのバージョンが揃っているか）
    - name: syncpack
      run: bun syncpack lint
    # 未使用ファイル・依存関係チェック
    - name: knip
      run: bun run knip
    # ユニットテスト（bun test）
    - name: unit-test
      run: bun run test
    # E2E テスト（Playwright / Next.js dev サーバーを自動起動して実行）
    - name: e2e-test
      run: cd apps/web && bunx playwright test
