# Storybook VRTï¼ˆãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ãƒªã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆï¼‰ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
#
# packages/ui/ é…ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚ŒãŸ PR ã§è‡ªå‹•å®Ÿè¡Œã•ã‚Œã‚‹ã€‚
# storybook-addon-vis + vitest browser mode ã§ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’æ’®å½±ã—ã€
# reg-cli ã§å·®åˆ†ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã™ã‚‹ã€‚Storybook ãƒ“ãƒ«ãƒ‰ä¸è¦ã€‚
name: Storybook VRT

on:
  pull_request:
    branches: [main]
    # packages/ui/ ã®å¤‰æ›´æ™‚ã®ã¿å®Ÿè¡Œï¼ˆapps/web/ ã®ã¿ã®å¤‰æ›´ã§ã¯ä¸è¦ï¼‰
    paths:
      - "packages/ui/**"
  workflow_dispatch:

permissions:
  actions: read
  contents: write
  pull-requests: write

# ãƒ¬ãƒãƒ¼ãƒˆã®å‡ºåŠ›å…ˆãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹
# PR æ™‚: pr/{PRç•ªå·}  ï¼ˆä¾‹: pr/42ï¼‰
# æ‰‹å‹•å®Ÿè¡Œæ™‚: manual/{å®Ÿè¡ŒID}  ï¼ˆä¾‹: manual/12345ï¼‰
env:
  REPORT_PREFIX: ${{ github.event.pull_request.number && format('pr/{0}', github.event.pull_request.number) || format('manual/{0}', github.run_id) }}

jobs:
  test:
    name: "\U0001F4F8 Storybook VRT"
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      vrt-table: ${{ steps.reg-result.outputs.vrt-table }}
    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      - uses: actions/checkout@v6
        with:
          # ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ç”Ÿæˆã§ base branch ã‚’å‚ç…§ã™ã‚‹ãŸã‚å…¨å±¥æ­´ãŒå¿…è¦
          fetch-depth: 0

      # bun ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ï¼‰
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      # Playwright ãƒ–ãƒ©ã‚¦ã‚¶ãƒã‚¤ãƒŠãƒªã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆChromium ã®ã¿ï¼‰
      # vitest browser mode ãŒå†…éƒ¨ã§ Playwright ã‚’ä½¿ç”¨
      - name: Get Playwright version
        id: pw-version
        run: echo "version=$(bunx playwright --version | awk '{print $2}')" >> $GITHUB_OUTPUT

      - name: Cache Playwright browsers
        id: pw-cache
        uses: actions/cache@v5
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ steps.pw-version.outputs.version }}

      - name: Install Playwright browsers
        if: steps.pw-cache.outputs.cache-hit != 'true'
        run: bunx playwright install --with-deps chromium

      # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆæ™‚ã‚‚ã‚·ã‚¹ãƒ†ãƒ ä¾å­˜ï¼ˆlibgbm ç­‰ï¼‰ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¯å¿…è¦
      - name: Install Playwright system dependencies
        if: steps.pw-cache.outputs.cache-hit == 'true'
        run: bunx playwright install-deps chromium

      # ãƒ¢ãƒãƒ¬ãƒå…¨ä½“ã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆlockfile ã‚’å³å¯†ã«ä½¿ç”¨ï¼‰
      - name: Install dependencies
        run: bun install --frozen-lockfile

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ç”Ÿæˆ â†’ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      # PR æ™‚ã®ã¿: ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒã®ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’ç”Ÿæˆã—ã€
      # .reg/expected/ ã«ã‚³ãƒ”ãƒ¼ã™ã‚‹ã€‚ã“ã‚Œã«ã‚ˆã‚Š reg-cli ã§å·®åˆ†æ¯”è¼ƒãŒå¯èƒ½ã«ãªã‚‹ã€‚
      - name: Generate baselines from base branch
        if: github.event_name == 'pull_request'
        run: |
          BASE_REF="${{ github.event.pull_request.base.ref }}"
          git worktree add /tmp/baseline "origin/${BASE_REF}" --detach
          cd /tmp/baseline
          bun install --frozen-lockfile
          cd packages/ui
          bun run vrt:snapshot || true
          mkdir -p $GITHUB_WORKSPACE/packages/ui/.reg/expected/
          cp -r .reg/actual/* $GITHUB_WORKSPACE/packages/ui/.reg/expected/ || true
          cd $GITHUB_WORKSPACE
          git worktree remove /tmp/baseline --force

      # vitest browser mode ã§ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆæ’®å½±ï¼ˆStorybook ãƒ“ãƒ«ãƒ‰ä¸è¦ï¼‰
      - name: Run VRT snapshots
        run: bun run vrt:snapshot
        working-directory: packages/ui
        env:
          CI: true

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      # reg-cli: .reg/expected/ï¼ˆãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ï¼‰ã¨ .reg/actual/ï¼ˆç¾åœ¨ï¼‰ã‚’æ¯”è¼ƒã—ã€
      # å·®åˆ†ãƒ¬ãƒãƒ¼ãƒˆã‚’ .reg/ ã«ç”Ÿæˆã™ã‚‹ã€‚çµæœã‚µãƒãƒªãƒ¼ã¯ PR ã‚³ãƒ¡ãƒ³ãƒˆç”¨ã« GITHUB_OUTPUT ã«å‡ºåŠ›ã€‚
      - name: Run reg-cli comparison
        if: always()
        id: reg-result
        run: |
          bun run vrt:report:reg || true

          # .reg/out.json ã‹ã‚‰å„ã‚«ãƒ†ã‚´ãƒªã®ä»¶æ•°ã‚’å–å¾—
          CHANGED=$(jq '.diffItems | length' .reg/out.json)
          PASSED=$(jq '.passedItems | length' .reg/out.json)
          NEW=$(jq '.newItems | length' .reg/out.json)
          DELETED=$(jq '.deletedItems | length' .reg/out.json)

          # PR ã‚³ãƒ¡ãƒ³ãƒˆç”¨ã®ã‚µãƒãƒªãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’çµ„ã¿ç«‹ã¦ï¼ˆreg-cli ãƒ¬ãƒãƒ¼ãƒˆã¨åŒã˜é †åºã€ä»¶æ•° 0 ã¯çœç•¥ï¼‰
          VRT_TABLE="| Status | Count |
          |--------|-------|"
          [ "$CHANGED" -gt 0 ] && VRT_TABLE="$VRT_TABLE
          | âš ï¸ Changed | $CHANGED |"
          [ "$NEW" -gt 0 ] && VRT_TABLE="$VRT_TABLE
          | ğŸ†• New | $NEW |"
          [ "$DELETED" -gt 0 ] && VRT_TABLE="$VRT_TABLE
          | ğŸ—‘ï¸ Deleted | $DELETED |"
          [ "$PASSED" -gt 0 ] && VRT_TABLE="$VRT_TABLE
          | âœ… Passed | $PASSED |"

          # GITHUB_OUTPUT ã«ãƒ’ã‚¢ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§å‡ºåŠ›ï¼ˆè¤‡æ•°è¡Œå¯¾å¿œï¼‰
          echo "vrt-table<<EOF" >> $GITHUB_OUTPUT
          echo "$VRT_TABLE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        working-directory: packages/ui

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼†ãƒ‡ãƒ—ãƒ­ã‚¤
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      # reg-cli ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°
      - name: Stage reports for GitHub Pages
        if: always()
        run: |
          DEST="${{ env.REPORT_PREFIX }}/storybook-vrt"
          mkdir -p _gh-pages-staging/${DEST}/reg-report
          cp -r .reg/* _gh-pages-staging/${DEST}/reg-report/ || true
        working-directory: packages/ui

      # deploy ã‚¸ãƒ§ãƒ–ã«æ¸¡ã™ãŸã‚ã®ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆï¼ˆã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°æ¸ˆã¿ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä¸€å¼ï¼‰
      - name: Upload deploy payload
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: storybook-vrt-deploy-payload
          path: packages/ui/_gh-pages-staging/
          retention-days: 1

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆgh-pages ã¸ã® push ã®ã¿ç›´åˆ—åŒ–ï¼‰
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy:
    name: "Deploy \U0001F4F8 Storybook VRT Report"
    needs: test
    if: ${{ !cancelled() }}
    runs-on: ubuntu-latest
    timeout-minutes: 5
    # gh-pages ãƒ–ãƒ©ãƒ³ãƒã¸ã® push ãŒç«¶åˆã—ãªã„ã‚ˆã†ã«ã‚­ãƒ¥ãƒ¼ã‚¤ãƒ³ã‚°
    concurrency:
      group: gh-pages-deploy
      cancel-in-progress: false
    steps:
      - name: Download deploy payload
        uses: actions/download-artifact@v6
        with:
          name: storybook-vrt-deploy-payload
          path: _gh-pages-staging/

      - name: Deploy reports to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: _gh-pages-staging
          keep_files: true

      # sticky-pull-request-comment: åŒã˜ header ã®ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Œã°æ›´æ–°ã€ãªã‘ã‚Œã°æ–°è¦ä½œæˆ
      - name: Comment PR with report links
        if: always()
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: storybook-vrt-report
          message: |
            ## ğŸ“¸ Storybook VRT Report

            ${{ needs.test.outputs.vrt-table }}

            | Report | Link |
            |--------|------|
            | reg-cli | https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${{ env.REPORT_PREFIX }}/storybook-vrt/reg-report/report/ |

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³å¯è¦–åŒ–
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  actions-timeline:
    name: Actions Timeline
    needs: [test, deploy]
    if: ${{ !cancelled() }}
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: Kesin11/actions-timeline@v3
