# Playwright ãƒ†ã‚¹ãƒˆå…±é€šãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ï¼ˆReusable Workflowï¼‰
#
# VRT / E2E ãƒ†ã‚¹ãƒˆã®å…±é€šå‡¦ç†ã‚’ã¾ã¨ã‚ãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã€‚
# workflow_call ã§å‘¼ã³å‡ºã•ã‚Œã€inputs ã§ãƒ†ã‚¹ãƒˆç¨®åˆ¥ã”ã¨ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚‹ã€‚
#
# å‘¼ã³å‡ºã—å…ƒ:
#   - storybook-vrt.ymlï¼ˆStorybook VRTï¼‰
#   - web-e2e.ymlï¼ˆWeb ã‚¢ãƒ—ãƒª E2E ãƒ†ã‚¹ãƒˆï¼‰
#
# å‡¦ç†ãƒ•ãƒ­ãƒ¼:
#   1. [test ã‚¸ãƒ§ãƒ–] ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— â†’ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ â†’ ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ â†’ ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
#   2. [deploy ã‚¸ãƒ§ãƒ–] GitHub Pages ãƒ‡ãƒ—ãƒ­ã‚¤ â†’ PR ã‚³ãƒ¡ãƒ³ãƒˆ
#
# concurrency è¨­è¨ˆ:
#   test ã‚¸ãƒ§ãƒ–ã¯ concurrency ãªã—ï¼ˆVRT ã¨ E2E ãŒä¸¦åˆ—å®Ÿè¡Œå¯èƒ½ï¼‰ã€‚
#   deploy ã‚¸ãƒ§ãƒ–ã®ã¿ concurrency: gh-pages-deployï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤ã ã‘ç›´åˆ—åŒ–ï¼‰ã€‚
name: Playwright Test

on:
  workflow_call:
    inputs:
      test-type:
        description: "ãƒ†ã‚¹ãƒˆç¨®åˆ¥ (storybook-vrt / web-e2e)"
        required: true
        type: string
      working-directory:
        description: "ãƒ†ã‚¹ãƒˆå®Ÿè¡Œãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª (packages/ui / apps/web)"
        required: true
        type: string
      build-command:
        description: "ãƒ“ãƒ«ãƒ‰ã‚³ãƒãƒ³ãƒ‰ (bun run build-storybook / bun run build)"
        required: true
        type: string
      report-script:
        description: "reg-cli ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ (vrt:report:reg / e2e:report:reg)"
        required: true
        type: string
      report-title:
        description: "PR ã‚³ãƒ¡ãƒ³ãƒˆã®ãƒ¬ãƒãƒ¼ãƒˆã‚¿ã‚¤ãƒˆãƒ«"
        required: true
        type: string

# ãƒ¬ãƒãƒ¼ãƒˆã®å‡ºåŠ›å…ˆãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹
# PR æ™‚: pr/{PRç•ªå·}  ï¼ˆä¾‹: pr/42ï¼‰
# æ‰‹å‹•å®Ÿè¡Œæ™‚: manual/{å®Ÿè¡ŒID}  ï¼ˆä¾‹: manual/12345ï¼‰
env:
  REPORT_PREFIX: ${{ github.event.pull_request.number && format('pr/{0}', github.event.pull_request.number) || format('manual/{0}', github.run_id) }}

jobs:
  test:
    name: ${{ inputs.report-title }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      vrt-table: ${{ steps.reg-result.outputs.vrt-table }}
    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      - uses: actions/checkout@v6
        with:
          # ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ç”Ÿæˆã§ base branch ã‚’å‚ç…§ã™ã‚‹ãŸã‚å…¨å±¥æ­´ãŒå¿…è¦
          fetch-depth: 0

      # bun ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ï¼‰
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      # Playwright ãƒ–ãƒ©ã‚¦ã‚¶ãƒã‚¤ãƒŠãƒªã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆChromium ã®ã¿ï¼‰
      # ã‚­ãƒ¼ã« Playwright ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å«ã‚ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°æ™‚ã«è‡ªå‹•ã§å†ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹
      - name: Get Playwright version
        id: pw-version
        run: echo "version=$(bunx playwright --version | awk '{print $2}')" >> $GITHUB_OUTPUT

      - name: Cache Playwright browsers
        id: pw-cache
        uses: actions/cache@v5
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ steps.pw-version.outputs.version }}

      - name: Install Playwright browsers
        if: steps.pw-cache.outputs.cache-hit != 'true'
        run: bunx playwright install --with-deps chromium

      # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆæ™‚ã‚‚ã‚·ã‚¹ãƒ†ãƒ ä¾å­˜ï¼ˆlibgbm ç­‰ï¼‰ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¯å¿…è¦
      - name: Install Playwright system dependencies
        if: steps.pw-cache.outputs.cache-hit == 'true'
        run: bunx playwright install-deps chromium

      # ãƒ¢ãƒãƒ¬ãƒå…¨ä½“ã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆlockfile ã‚’å³å¯†ã«ä½¿ç”¨ï¼‰
      - name: Install dependencies
        run: bun install --frozen-lockfile

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ç”Ÿæˆ â†’ ãƒ“ãƒ«ãƒ‰ â†’ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      # PR æ™‚ã®ã¿: ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒã®ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’ç”Ÿæˆã—ã€
      # .reg/expected/ ã«ã‚³ãƒ”ãƒ¼ã™ã‚‹ã€‚ã“ã‚Œã«ã‚ˆã‚Š reg-cli ã§å·®åˆ†æ¯”è¼ƒãŒå¯èƒ½ã«ãªã‚‹ã€‚
      # git worktree ã‚’ä½¿ã£ã¦åˆ¥ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã—ã€
      # ãã“ã§ãƒ“ãƒ«ãƒ‰ï¼†ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’å–å¾—ã™ã‚‹ã€‚
      - name: Generate baselines from base branch
        if: github.event_name == 'pull_request'
        run: |
          BASE_REF="${{ github.event.pull_request.base.ref }}"
          git worktree add /tmp/baseline "origin/${BASE_REF}" --detach
          cd /tmp/baseline
          bun install --frozen-lockfile
          cd ${{ inputs.working-directory }}
          ${{ inputs.build-command }}
          bunx playwright test || true
          mkdir -p $GITHUB_WORKSPACE/${{ inputs.working-directory }}/.reg/expected/
          cp -r .reg/actual/* $GITHUB_WORKSPACE/${{ inputs.working-directory }}/.reg/expected/ || true
          cd $GITHUB_WORKSPACE
          git worktree remove /tmp/baseline --force

      # ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒã§ãƒ“ãƒ«ãƒ‰ï¼ˆVRT: Storybook ãƒ“ãƒ«ãƒ‰ / E2E: Next.js ãƒ“ãƒ«ãƒ‰ï¼‰
      - name: Build
        run: ${{ inputs.build-command }}
        working-directory: ${{ inputs.working-directory }}

      # Playwright ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆVRT: ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆæ’®å½± / E2E: ãƒšãƒ¼ã‚¸é·ç§»ãƒ»ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–æ¤œè¨¼ï¼‰
      # ãƒ†ã‚¹ãƒˆçµæœã¯ playwright-report/ ã¨ allure-results/ ã«å‡ºåŠ›ã•ã‚Œã‚‹
      - name: Run Playwright tests
        run: bunx playwright test
        working-directory: ${{ inputs.working-directory }}
        env:
          CI: true

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      # GitHub Pages ã‹ã‚‰ Allure å±¥æ­´ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆJSONLï¼‰ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã€‚
      # Allure Report v3 ã§ã¯ history/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ã¯ãªãå˜ä¸€ã® JSONL ãƒ•ã‚¡ã‚¤ãƒ«ã§å±¥æ­´ã‚’ç®¡ç†ã™ã‚‹ã€‚
      # åˆå›å®Ÿè¡Œæ™‚ã‚„ãƒšãƒ¼ã‚¸æœªãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã¯ 404 ã«ãªã‚‹ãŒã€|| true ã§ç„¡è¦–ã™ã‚‹ã€‚
      - name: Download previous Allure history
        if: always()
        run: |
          PAGES_BASE="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
          HISTORY_URL="${PAGES_BASE}/latest/${{ inputs.test-type }}/allure-history.jsonl"
          curl -sSfL "${HISTORY_URL}" -o "allure-history.jsonl" || true
        working-directory: ${{ inputs.working-directory }}

      # allure-results/ ã‹ã‚‰ Allure ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆï¼ˆãƒªãƒƒãƒãªãƒ†ã‚¹ãƒˆçµæœãƒ“ãƒ¥ãƒ¼ã‚¢ï¼‰
      # --history-path ã§ JSONL å±¥æ­´ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã™ã‚‹ã¨ã€ãƒˆãƒ¬ãƒ³ãƒ‰ã‚°ãƒ©ãƒ•ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã€‚
      # appendHistoryï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ trueï¼‰ã«ã‚ˆã‚Šç¾åœ¨ã®å®Ÿè¡ŒçµæœãŒå±¥æ­´ãƒ•ã‚¡ã‚¤ãƒ«ã«è¿½è¨˜ã•ã‚Œã‚‹ã€‚
      - name: Generate Allure report
        if: always()
        run: |
          HISTORY_OPT=""
          if [ -f allure-history.jsonl ]; then
            HISTORY_OPT="--history-path allure-history.jsonl"
          fi
          rm -rf allure-report && bunx allure generate allure-results -o allure-report $HISTORY_OPT
        working-directory: ${{ inputs.working-directory }}

      # reg-cli: .reg/expected/ï¼ˆãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ï¼‰ã¨ .reg/actual/ï¼ˆç¾åœ¨ï¼‰ã‚’æ¯”è¼ƒã—ã€
      # å·®åˆ†ãƒ¬ãƒãƒ¼ãƒˆã‚’ .reg/ ã«ç”Ÿæˆã™ã‚‹ã€‚çµæœã‚µãƒãƒªãƒ¼ã¯ PR ã‚³ãƒ¡ãƒ³ãƒˆç”¨ã« GITHUB_OUTPUT ã«å‡ºåŠ›ã€‚
      - name: Run reg-cli comparison
        if: always()
        id: reg-result
        run: |
          bun run ${{ inputs.report-script }} || true

          # .reg/out.json ã‹ã‚‰å„ã‚«ãƒ†ã‚´ãƒªã®ä»¶æ•°ã‚’å–å¾—
          CHANGED=$(jq '.diffItems | length' .reg/out.json)
          PASSED=$(jq '.passedItems | length' .reg/out.json)
          NEW=$(jq '.newItems | length' .reg/out.json)
          DELETED=$(jq '.deletedItems | length' .reg/out.json)

          # PR ã‚³ãƒ¡ãƒ³ãƒˆç”¨ã®ã‚µãƒãƒªãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’çµ„ã¿ç«‹ã¦ï¼ˆreg-cli ãƒ¬ãƒãƒ¼ãƒˆã¨åŒã˜é †åºã€ä»¶æ•° 0 ã¯çœç•¥ï¼‰
          VRT_TABLE="| Status | Count |
          |--------|-------|"
          [ "$CHANGED" -gt 0 ] && VRT_TABLE="$VRT_TABLE
          | âš ï¸ Changed | $CHANGED |"
          [ "$NEW" -gt 0 ] && VRT_TABLE="$VRT_TABLE
          | ğŸ†• New | $NEW |"
          [ "$DELETED" -gt 0 ] && VRT_TABLE="$VRT_TABLE
          | ğŸ—‘ï¸ Deleted | $DELETED |"
          [ "$PASSED" -gt 0 ] && VRT_TABLE="$VRT_TABLE
          | âœ… Passed | $PASSED |"

          # GITHUB_OUTPUT ã«ãƒ’ã‚¢ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§å‡ºåŠ›ï¼ˆè¤‡æ•°è¡Œå¯¾å¿œï¼‰
          echo "vrt-table<<EOF" >> $GITHUB_OUTPUT
          echo "$VRT_TABLE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        working-directory: ${{ inputs.working-directory }}

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼†ãƒ‡ãƒ—ãƒ­ã‚¤
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      # ãƒ†ã‚¹ãƒˆå¤±æ•—æ™‚ã®ã¿: ãƒ‡ãƒãƒƒã‚°ç”¨ã«ãƒ†ã‚¹ãƒˆçµæœï¼ˆã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆãƒ»ãƒˆãƒ¬ãƒ¼ã‚¹ç­‰ï¼‰ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: ${{ inputs.test-type }}-report
          path: ${{ inputs.working-directory }}/test-results/
          retention-days: 30

      # Playwright æ¨™æº–ã® HTML ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - name: Upload HTML report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: ${{ inputs.test-type }}-html-report
          path: ${{ inputs.working-directory }}/playwright-report/
          retention-days: 30

      # Allure ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - name: Upload Allure report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: ${{ inputs.test-type }}-allure-report
          path: ${{ inputs.working-directory }}/allure-report/
          retention-days: 30

      # å…¨ãƒ¬ãƒãƒ¼ãƒˆã‚’1ã¤ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã¾ã¨ã‚ã€1å›ã® push ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã€‚
      # 3å›ã«åˆ†ã‘ã‚‹ã¨ gh-pages ãƒ–ãƒ©ãƒ³ãƒã¸ã® push ãŒç«¶åˆã—ã‚„ã™ã„ãŸã‚çµ±åˆã—ã¦ã„ã‚‹ã€‚
      # keep_files: true ã§æ—¢å­˜ã®ãƒ¬ãƒãƒ¼ãƒˆã‚’ä¿æŒã™ã‚‹ï¼ˆä»–ã® PR ã®ãƒ¬ãƒãƒ¼ãƒˆã‚’æ¶ˆã•ãªã„ï¼‰
      - name: Stage reports for GitHub Pages
        if: always()
        run: |
          DEST="${{ env.REPORT_PREFIX }}/${{ inputs.test-type }}"
          mkdir -p _gh-pages-staging/${DEST}/html-report
          mkdir -p _gh-pages-staging/${DEST}/allure-report
          mkdir -p _gh-pages-staging/${DEST}/reg-report
          cp -r playwright-report/* _gh-pages-staging/${DEST}/html-report/ || true
          cp -r allure-report/* _gh-pages-staging/${DEST}/allure-report/ || true
          cp -r .reg/* _gh-pages-staging/${DEST}/reg-report/ || true

          # Allure å±¥æ­´ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆJSONLï¼‰ã‚’å…±æœ‰ãƒ‘ã‚¹ã«ã‚³ãƒ”ãƒ¼ï¼ˆå…¨ PR ã§å±¥æ­´ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ï¼‰
          if [ -f allure-history.jsonl ]; then
            mkdir -p _gh-pages-staging/latest/${{ inputs.test-type }}
            cp allure-history.jsonl _gh-pages-staging/latest/${{ inputs.test-type }}/allure-history.jsonl
          fi
        working-directory: ${{ inputs.working-directory }}

      # deploy ã‚¸ãƒ§ãƒ–ã«æ¸¡ã™ãŸã‚ã®ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆï¼ˆã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°æ¸ˆã¿ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä¸€å¼ï¼‰
      - name: Upload deploy payload
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: ${{ inputs.test-type }}-deploy-payload
          path: ${{ inputs.working-directory }}/_gh-pages-staging/
          retention-days: 1

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆgh-pages ã¸ã® push ã®ã¿ç›´åˆ—åŒ–ï¼‰
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy:
    name: Deploy ${{ inputs.report-title }}
    needs: test
    if: ${{ !cancelled() }}
    runs-on: ubuntu-latest
    timeout-minutes: 5
    # gh-pages ãƒ–ãƒ©ãƒ³ãƒã¸ã® push ãŒç«¶åˆã—ãªã„ã‚ˆã†ã«ã‚­ãƒ¥ãƒ¼ã‚¤ãƒ³ã‚°
    # ï¼ˆVRT ã¨ E2E ãŒåŒæ™‚å®Ÿè¡Œã•ã‚Œã¦ã‚‚ deploy ã¯é †ç•ªã«å‡¦ç†ã•ã‚Œã‚‹ï¼‰
    concurrency:
      group: gh-pages-deploy
      cancel-in-progress: false
    steps:
      - name: Download deploy payload
        uses: actions/download-artifact@v6
        with:
          name: ${{ inputs.test-type }}-deploy-payload
          path: _gh-pages-staging/

      - name: Deploy reports to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: _gh-pages-staging
          keep_files: true

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # PR ã‚³ãƒ¡ãƒ³ãƒˆ
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      # sticky-pull-request-comment: åŒã˜ header ã®ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Œã°æ›´æ–°ã€ãªã‘ã‚Œã°æ–°è¦ä½œæˆ
      # å„ãƒ¬ãƒãƒ¼ãƒˆã® GitHub Pages URL ã¨ reg-cli ã®å·®åˆ†ã‚µãƒãƒªãƒ¼ã‚’è¡¨ç¤ºã™ã‚‹
      - name: Comment PR with report links
        if: always()
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: ${{ inputs.test-type }}-report
          message: |
            ## ${{ inputs.report-title }}

            ${{ needs.test.outputs.vrt-table }}

            | Report | Link |
            |--------|------|
            | reg-cli | https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${{ env.REPORT_PREFIX }}/${{ inputs.test-type }}/reg-report/report/ |
            | Playwright HTML | https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${{ env.REPORT_PREFIX }}/${{ inputs.test-type }}/html-report/ |
            | Allure | https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${{ env.REPORT_PREFIX }}/${{ inputs.test-type }}/allure-report/ |
