# E2E テストワークフロー
#
# apps/web/ または packages/ui/ 配下のファイルが変更された PR で自動実行される。
# Next.js アプリをビルドし、Playwright でページ遷移やレスポンシブ表示などを検証する。
# UI パッケージの変更も Web アプリに影響するため、両方のパスをトリガーに含める。
name: E2E Tests

on:
  pull_request:
    branches: [main]
    # apps/web/ と packages/ui/ の変更時に実行
    # UI コンポーネントの変更が Web アプリに影響する可能性があるため両方を監視
    paths:
      - "apps/web/**"
      - "packages/ui/**"
  workflow_dispatch:

permissions:
  contents: write      # peaceiris/actions-gh-pages が gh-pages に push
  pull-requests: write # PR コメント投稿

env:
  REPORT_PREFIX: ${{ github.event.pull_request.number && format('pr/{0}', github.event.pull_request.number) || format('manual/{0}', github.run_id) }}

jobs:
  e2e:
    name: E2E Test
    runs-on: ubuntu-latest
    # Playwright の公式 Docker イメージを使用（ブラウザがプリインストール済み）
    # バージョンは @playwright/test のバージョンと一致させること
    container:
      image: mcr.microsoft.com/playwright:v1.58.2-noble
    steps:
      - uses: actions/checkout@v6

      # Playwright Docker イメージに unzip が未同梱のため追加（setup-bun に必要）
      - run: apt-get update && apt-get install -y unzip

      # bun をセットアップ（パッケージマネージャー）
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      # モノレポ全体の依存関係をインストール（lockfile を厳密に使用）
      - name: Install dependencies
        run: bun install --frozen-lockfile

      # Next.js アプリをビルド（本番ビルドに対してテストを実行）
      - name: Build application
        run: bun run build
        working-directory: apps/web

      # E2E テスト実行: ページ遷移、レスポンシブ表示、スクリーンショット比較を検証
      - name: Run E2E tests
        run: bunx playwright test
        working-directory: apps/web
        env:
          CI: true

      # テスト失敗時: 差分画像を含むテスト結果をアップロード
      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: e2e-report
          path: apps/web/test-results/
          retention-days: 30

      # 常時: HTML レポートをアーティファクトとしてアップロード
      - name: Upload HTML report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: e2e-html-report
          path: apps/web/playwright-report/
          retention-days: 30

      # Allure レポートを生成
      - name: Generate Allure report
        if: always()
        run: rm -rf allure-report && bunx allure generate allure-results -o allure-report
        working-directory: apps/web

      # Allure レポートをアーティファクトとしてアップロード
      - name: Upload Allure report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: e2e-allure-report
          path: apps/web/allure-report/
          retention-days: 30

      # HTML レポートを GitHub Pages にデプロイ（/e2e/html-report/ 配下）
      - name: Deploy HTML report to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: apps/web/playwright-report
          destination_dir: ${{ env.REPORT_PREFIX }}/e2e/html-report
          keep_files: true

      # Allure レポートを GitHub Pages にデプロイ（/e2e/allure-report/ 配下）
      - name: Deploy Allure report to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: apps/web/allure-report
          destination_dir: ${{ env.REPORT_PREFIX }}/e2e/allure-report
          keep_files: true

      # reg-cli: ベースラインと比較してレポート生成（E2E 実行時に .reg/actual/ へ自動保存済み）
      - name: Run reg-cli comparison
        if: always()
        id: reg-result
        run: |
          bun run e2e:report:reg || true

          CHANGED=$(jq '.diffItems | length' .reg/out.json)
          PASSED=$(jq '.passedItems | length' .reg/out.json)
          NEW=$(jq '.newItems | length' .reg/out.json)
          DELETED=$(jq '.deletedItems | length' .reg/out.json)

          VRT_TABLE="| Status | Count |
          |--------|-------|"
          [ "$CHANGED" -gt 0 ] && VRT_TABLE="$VRT_TABLE
          | Changed | $CHANGED |"
          [ "$PASSED" -gt 0 ] && VRT_TABLE="$VRT_TABLE
          | Passed | $PASSED |"
          [ "$NEW" -gt 0 ] && VRT_TABLE="$VRT_TABLE
          | New | $NEW |"
          [ "$DELETED" -gt 0 ] && VRT_TABLE="$VRT_TABLE
          | Deleted | $DELETED |"

          echo "vrt-table<<EOF" >> $GITHUB_OUTPUT
          echo "$VRT_TABLE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        working-directory: apps/web

      # reg-cli レポートを GitHub Pages にデプロイ
      - name: Deploy reg-cli report to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: apps/web/.reg/report
          destination_dir: ${{ env.REPORT_PREFIX }}/e2e/reg-report
          keep_files: true

      # PR に reg-cli レポートリンクをコメント
      - name: Comment PR with reg-cli results
        if: always()
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: e2e-reg-report
          message: |
            ## E2E - reg-cli Report

            ${{ steps.reg-result.outputs.vrt-table }}

            **View Report**: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${{ env.REPORT_PREFIX }}/e2e/reg-report/

      # PR にレポートへのリンクをコメント
      - name: Comment PR with report links
        if: always()
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: e2e-report
          message: |
            ## E2E Test Report

            | Report | Link |
            |--------|------|
            | Playwright HTML | https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${{ env.REPORT_PREFIX }}/e2e/html-report/ |
            | Allure | https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${{ env.REPORT_PREFIX }}/e2e/allure-report/ |

            <details>
            <summary>Artifacts</summary>

            GitHub Pages のデプロイに失敗した場合は、Actions の Artifacts からもダウンロードできます。
            - `e2e-html-report` — Playwright HTML レポート
            - `e2e-allure-report` — Allure レポート

            </details>
