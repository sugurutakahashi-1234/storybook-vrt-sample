# E2E ãƒ†ã‚¹ãƒˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
#
# apps/web/ ã¾ãŸã¯ packages/ui/ é…ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚ŒãŸ PR ã§è‡ªå‹•å®Ÿè¡Œã•ã‚Œã‚‹ã€‚
# Next.js ã‚¢ãƒ—ãƒªã‚’ãƒ“ãƒ«ãƒ‰ã—ã€Playwright ã§ãƒšãƒ¼ã‚¸é·ç§»ã‚„ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–è¡¨ç¤ºãªã©ã‚’æ¤œè¨¼ã™ã‚‹ã€‚
# UI ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®å¤‰æ›´ã‚‚ Web ã‚¢ãƒ—ãƒªã«å½±éŸ¿ã™ã‚‹ãŸã‚ã€ä¸¡æ–¹ã®ãƒ‘ã‚¹ã‚’ãƒˆãƒªã‚¬ãƒ¼ã«å«ã‚ã‚‹ã€‚
name: E2E Tests

on:
  pull_request:
    branches: [main]
    # apps/web/ ã¨ packages/ui/ ã®å¤‰æ›´æ™‚ã«å®Ÿè¡Œ
    # UI ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å¤‰æ›´ãŒ Web ã‚¢ãƒ—ãƒªã«å½±éŸ¿ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ä¸¡æ–¹ã‚’ç›£è¦–
    paths:
      - "apps/web/**"
      - "packages/ui/**"
  workflow_dispatch:

permissions:
  contents: write      # peaceiris/actions-gh-pages ãŒ gh-pages ã« push
  pull-requests: write # PR ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿

env:
  REPORT_PREFIX: ${{ github.event.pull_request.number && format('pr/{0}', github.event.pull_request.number) || format('manual/{0}', github.run_id) }}

jobs:
  e2e:
    name: E2E Test
    runs-on: ubuntu-latest
    # Playwright ã®å…¬å¼ Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ç”¨ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ãŒãƒ—ãƒªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ï¼‰
    # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ @playwright/test ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ä¸€è‡´ã•ã›ã‚‹ã“ã¨
    container:
      image: mcr.microsoft.com/playwright:v1.58.2-noble
    steps:
      - uses: actions/checkout@v6

      # Playwright Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã« unzip ãŒæœªåŒæ¢±ã®ãŸã‚è¿½åŠ ï¼ˆsetup-bun ã«å¿…è¦ï¼‰
      - run: apt-get update && apt-get install -y unzip jq

      # bun ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ï¼‰
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      # ãƒ¢ãƒãƒ¬ãƒå…¨ä½“ã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆlockfile ã‚’å³å¯†ã«ä½¿ç”¨ï¼‰
      - name: Install dependencies
        run: bun install --frozen-lockfile

      # Next.js ã‚¢ãƒ—ãƒªã‚’ãƒ“ãƒ«ãƒ‰ï¼ˆæœ¬ç•ªãƒ“ãƒ«ãƒ‰ã«å¯¾ã—ã¦ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œï¼‰
      - name: Build application
        run: bun run build
        working-directory: apps/web

      # E2E ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ: ãƒšãƒ¼ã‚¸é·ç§»ã€ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–è¡¨ç¤ºã€ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆæ¯”è¼ƒã‚’æ¤œè¨¼
      - name: Run E2E tests
        run: bunx playwright test
        working-directory: apps/web
        env:
          CI: true

      # ãƒ†ã‚¹ãƒˆå¤±æ•—æ™‚: å·®åˆ†ç”»åƒã‚’å«ã‚€ãƒ†ã‚¹ãƒˆçµæœã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: e2e-report
          path: apps/web/test-results/
          retention-days: 30

      # å¸¸æ™‚: HTML ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - name: Upload HTML report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: e2e-html-report
          path: apps/web/playwright-report/
          retention-days: 30

      # Allure ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
      - name: Generate Allure report
        if: always()
        run: rm -rf allure-report && bunx allure generate allure-results -o allure-report
        working-directory: apps/web

      # Allure ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - name: Upload Allure report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: e2e-allure-report
          path: apps/web/allure-report/
          retention-days: 30

      # HTML ãƒ¬ãƒãƒ¼ãƒˆã‚’ GitHub Pages ã«ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆ/e2e/html-report/ é…ä¸‹ï¼‰
      - name: Deploy HTML report to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: apps/web/playwright-report
          destination_dir: ${{ env.REPORT_PREFIX }}/e2e/html-report
          keep_files: true

      # Allure ãƒ¬ãƒãƒ¼ãƒˆã‚’ GitHub Pages ã«ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆ/e2e/allure-report/ é…ä¸‹ï¼‰
      - name: Deploy Allure report to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: apps/web/allure-report
          destination_dir: ${{ env.REPORT_PREFIX }}/e2e/allure-report
          keep_files: true

      # reg-cli: ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã¨æ¯”è¼ƒã—ã¦ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆï¼ˆE2E å®Ÿè¡Œæ™‚ã« .reg/actual/ ã¸è‡ªå‹•ä¿å­˜æ¸ˆã¿ï¼‰
      - name: Run reg-cli comparison
        if: always()
        id: reg-result
        run: |
          bun run e2e:report:reg || true

          CHANGED=$(jq '.diffItems | length' .reg/out.json)
          PASSED=$(jq '.passedItems | length' .reg/out.json)
          NEW=$(jq '.newItems | length' .reg/out.json)
          DELETED=$(jq '.deletedItems | length' .reg/out.json)

          VRT_TABLE="| Status | Count |
          |--------|-------|"
          [ "$CHANGED" -gt 0 ] && VRT_TABLE="$VRT_TABLE
          | ğŸ”´ Changed | $CHANGED |"
          [ "$PASSED" -gt 0 ] && VRT_TABLE="$VRT_TABLE
          | ğŸŸ¢ Passed | $PASSED |"
          [ "$NEW" -gt 0 ] && VRT_TABLE="$VRT_TABLE
          | ğŸ†• New | $NEW |"
          [ "$DELETED" -gt 0 ] && VRT_TABLE="$VRT_TABLE
          | ğŸ—‘ï¸ Deleted | $DELETED |"

          echo "vrt-table<<EOF" >> $GITHUB_OUTPUT
          echo "$VRT_TABLE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        working-directory: apps/web

      # reg-cli ãƒ¬ãƒãƒ¼ãƒˆã‚’ GitHub Pages ã«ãƒ‡ãƒ—ãƒ­ã‚¤
      - name: Deploy reg-cli report to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: apps/web/.reg
          destination_dir: ${{ env.REPORT_PREFIX }}/e2e/reg-report
          keep_files: true

      # PR ã«ãƒ¬ãƒãƒ¼ãƒˆãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ¡ãƒ³ãƒˆ
      - name: Comment PR with report links
        if: always()
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: e2e-report
          message: |
            ## E2E Test Report

            ${{ steps.reg-result.outputs.vrt-table }}

            | Report | Link |
            |--------|------|
            | reg-cli | https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${{ env.REPORT_PREFIX }}/e2e/reg-report/report/ |
            | Playwright HTML | https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${{ env.REPORT_PREFIX }}/e2e/html-report/ |
            | Allure | https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${{ env.REPORT_PREFIX }}/e2e/allure-report/ |

            <details>
            <summary>Artifacts</summary>

            GitHub Pages ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã«å¤±æ•—ã—ãŸå ´åˆã¯ã€Actions ã® Artifacts ã‹ã‚‰ã‚‚ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚
            - `e2e-html-report` â€” Playwright HTML ãƒ¬ãƒãƒ¼ãƒˆ
            - `e2e-allure-report` â€” Allure ãƒ¬ãƒãƒ¼ãƒˆ

            </details>
